<!DOCTYPE html>
<html lang="en">
<head>
<base href="{{ request.script_root }}/">
<meta charset="UTF-8">
<title>Smart Bus Dashboard ‚Äì Singapore Live</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
:root {
  --bg-gradient: linear-gradient(180deg, #eef3f8, #cfd8e6);
  --text-color: #2c3e50;
  --card-bg: #ffffff;
  --table-head-bg: #2c3e50;
  --header-bg: linear-gradient(180deg, #111827 0%, #1f2937 100%);
  --accent: #626e70;
}

body.dark {
  --bg-gradient: linear-gradient(180deg, #20232a, #181b1f);
  --text-color: #e2e8f0;
  --card-bg: #2b3037;
  --table-head-bg: #3a3f47;
  --header-bg: linear-gradient(180deg, #111827 0%, #1f2937 100%); 
  --accent: #8ecae6;
}

body {
  margin: 0;
  font-family: "Segoe UI", Arial, sans-serif;
  background: var(--bg-gradient);
  color: var(--text-color);
  text-align: center;
  transition: background 0.4s, color 0.4s;
}

/* Header */
header {
  background: var(--header-bg);
  color: white;
  padding: 18px 0;
  font-size: 1.8em;
  font-weight: 600;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
}

/* Dark Mode Toggle */
#darkToggle {
  background: none;
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  font-size: 18px;
  width: 38px;
  height: 38px;
  cursor: pointer;
  transition: 0.3s;
}
#darkToggle:hover {
  background: white;
  color: #222;
}

/* Search Bar */
#controls {
  position: absolute;
  top: 95px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  width: 80%;
  max-width: 700px;
  background: var(--card-bg);
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  padding: 12px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

#query {
  flex: 1;
  padding: 10px 14px;
  border-radius: 10px;
  border: 1px solid #ccc;
}

button {
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 15px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.25s ease;
}
button.search { background: var(--accent); }
button.reset { background: #b0bec5; color: #2c3e50; }
button.refresh { background: var(--accent); color: white; }

/* Map */
#map {
  height: 70vh;
  width: 92%;
  margin: 20px auto;
  border-radius: 12px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.2);
}

/* Popup Buttons */
.leaflet-popup-content button {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s ease;
  display: block;
  width: 100%;
  margin-top: 5px;
}
.leaflet-popup-content button:hover { opacity: 0.85; }

/* Bus Card Section */
.bus-card {
  background: var(--card-bg);
  width: 90%;
  margin: 25px auto;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.1);
  transition: background 0.4s;
}

/* Update Bar */
#updateBar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  margin-bottom: 10px;
  width: 90%;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}
#lastUpdate {
  grid-column: 2;
  justify-self: center;
  background: #f2f4f6;
  color: #2c3e50;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
button.refresh { grid-column: 3; justify-self: end; }

/* Table */
.styled-table {
  border-collapse: collapse;
  margin: 15px auto;
  font-size: 16px;
  width: 98%;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  background-color: var(--card-bg);
  transition: background 0.3s;
}
.styled-table thead tr {
  background: var(--table-head-bg);
  color: #fff;
  text-align: center;
  font-weight: 600;
}
.styled-table th, .styled-table td {
  padding: 12px 16px;
  text-align: center;
}
.bus-badge {
  border-radius: 8px;
  padding: 4px 8px;
  font-weight: 600;
  color: white;
  display: inline-block;
}
.soon { background: #27ae60; }
.medium { background: #f1c40f; color: #222; }
.late { background: #e74c3c; }

/* Favorites */
#favorites {
  margin-top: 20px;
  text-align: center;
}
.favorite-stop {
  display: inline-block;
  background: #f2f4f6;
  color: #2c3e50;
  margin: 4px;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}
.favorite-stop span.delete {
  margin-left: 8px;
  color: #e74c3c;
  cursor: pointer;
  font-weight: bold;
}
.favorite-stop:hover { background: #e0e0e0; }

/* Compare Cards */
#compareContainer {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
}
.compare-card {
  background: var(--card-bg);
  border: 1px solid #ccc;
  border-radius: 12px;
  width: 300px;
  padding: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  transition: background 0.4s;
}
.compare-card h4 { margin: 8px 0; }

.btn-map {
  background-color: #2c3e50;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}
.btn-map:hover {
  background-color: #2c3e50;
}

.card-row {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
  align-items: stretch;
  margin-top: 10px;
}

.compare-card {
  flex: 0 1 300px;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  background: #fff;
  transition: transform 0.2s ease;
}

.compare-card:hover {
  transform: translateY(-3px);
}

</style>
</head>

<body>
    <script type="module">
    import { createSidebar } from "/static/navbar.js"; 
    createSidebar("bus"); // or "traffic"
  </script>

<div class="content">

<header>
 Hi {{ session.username if session.username else 'Guest' }}! üëã
  <button id="darkToggle" onclick="toggleDark()">üåô</button>
</header>

<div id="controls">
  <input id="query" placeholder="Enter bus stop code or road name">
  <button class="search" onclick="searchStops()">Search</button>
  <button class="reset" onclick="resetMap()">Reset</button>
</div>

<!-- üß≠ Route Calculator Panel -->
<div id="routeControls" style="
  position: absolute;
  top: 160px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  width: 80%;
  max-width: 700px;
  background: var(--card-bg);
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  padding: 12px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;">
  <input id="origin" placeholder="From (Bus Stop Code)" style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid #ccc;">
  <input id="destination" placeholder="To (Bus Stop Code)" style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid #ccc;">
  <button class="search" onclick="calculateRoute()">Find Route</button>
  <button class="reset" onclick="resetRoute()">Reset</button>
</div>

<div id="map"></div>

<div class="bus-card">
  <h3>Live Bus Arrival Times</h3>
  <div id="updateBar">
    <div></div>
    <div id="lastUpdate">Awaiting first update...</div>
    <button class="refresh" onclick="manualRefresh()">Refresh</button>
  </div>

  <table id="arrivalTable" class="styled-table">
    <thead><tr><th>Bus</th><th>Next</th><th>Following</th><th>Last</th><th>Type</th></tr></thead>
    <tbody id="arrivalBody"><tr><td colspan="5"><i>Click any stop marker on the map to view arrivals.</i></td></tr></tbody>
  </table>

  <div id="favorites">
    <h3>Favorite Stops</h3>
    <div id="favList"></div>
  </div>

  <!-- Top-3-Routes Section -->
  <div id="routeSection" style="margin-top:20px;">
    <h3>Top 3 Fastest Route(s)</h3>
    <div id="routeContainer" class="card-row"></div>
  </div>

  <!-- Compare Section -->
  <div id="compareSection" style="margin-top:30px;">
    <h3>Compare</h3>
    <div id="compareContainer" class="card-row"></div>
  </div>
</div>

<script>
const map = L.map('map').setView([1.35,103.82],12);
const lightTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19});
lightTiles.addTo(map);
const cluster = L.markerClusterGroup(); map.addLayer(cluster);
let activeStop="", activeStopName="";
let favoriteStops = JSON.parse(localStorage.getItem("favorites") || "[]");
let compareStops = [];
let savedLocationMarkers = []; // Array to store saved location markers

// Pressing Enter in the search box triggers the Search button
document.getElementById("query").addEventListener("keypress", function (event) {
  if (event.key === "Enter") {
    event.preventDefault(); // prevent page reload
    searchStops(); // call your existing search function
  }
});

// Pressing Enter in either route input triggers Find Route
["origin", "destination"].forEach(id => {
  document.getElementById(id).addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      calculateRoute(); // call your existing Find Route function
    }
  });
});

/* ROUTE CALCULATOR */
async function calculateRoute() {
  const origin = document.getElementById("origin").value.trim();
  const destination = document.getElementById("destination").value.trim();

  if (!origin || !destination) {
    alert("Please enter both origin and destination bus stop codes");
    return;
  }

  const response = await fetch("/api/route", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({origin, destination})
  });

  const data = await response.json();
  console.log("Route result:", data);

  const routeContainer = document.getElementById("routeContainer");
  routeContainer.innerHTML = "";

  if (data.routes && data.routes.length) {
    routeContainer.innerHTML = data.routes.map((r, i) => `
      <div class="compare-card">
        <h4>Option ${i + 1}: Bus ${r.service}</h4>
        <p>Stops: ${r.stops}</p>
        <p>Estimated Time: <b>${r.estimated_time_min} min</b></p>
        <button class="btn-map" onclick="drawRoute('${r.service}', '${origin}', '${destination}', ${r.direction})">
          Show on Map
        </button>
      </div>
    `).join("");
  } else {
    routeContainer.innerHTML = "<p>No direct route found.</p>";
  }
}

async function drawRoute(serviceNo, origin, destination, direction=1) {
  // remove previous route
  if (window.routeControl) {
    map.removeControl(window.routeControl);
  }

  const res = await fetch(`/bus_routes?service=${serviceNo}&direction=${direction}`);
  const data = await res.json();

  const stops = data.map(r => r.BusStopCode);
  const i1 = stops.indexOf(origin);
  const i2 = stops.indexOf(destination);
  if (i1 === -1 || i2 === -1 || i1 >= i2) {
    alert("Cannot map this route segment.");
    return;
  }

  const startRes = await fetch(`/bus_stops?query=${origin}`);
  const startData = await startRes.json();
  const endRes = await fetch(`/bus_stops?query=${destination}`);
  const endData = await endRes.json();

  if (!startData.length || !endData.length) return;

  const start = L.latLng(startData[0].lat, startData[0].lon);
  const end = L.latLng(endData[0].lat, endData[0].lon);

  window.routeControl = L.Routing.control({
    waypoints: [start, end],
    lineOptions: {
      styles: [{color: "#0033cc", weight: 5}]
    },
    addWaypoints: false,
    draggableWaypoints: false,
    fitSelectedRoutes: true
  }).addTo(map);
}

/* RESET ROUTE */
function resetRoute() {
  // Clear input fields
  document.getElementById("origin").value = "";
  document.getElementById("destination").value = "";

  // Clear route results display
  const container = document.getElementById("compareContainer");
  if (container) container.innerHTML = "";

  // Remove any drawn route line (polyline or routing control)
  if (window.drawnRoute) {
    map.removeLayer(window.drawnRoute);
    window.drawnRoute = null;
  }

  if (window.routeControl) {
    map.removeControl(window.routeControl);
    window.routeControl = null;
  }

  // Optional: reset map view to Singapore default (like your main reset button)
  map.setView([1.3521, 103.8198], 12);
}

// Load Favourite Bus Stops from API
// UPDATED: Load favorites from database instead of localStorage
async function loadFavoritesFromDB() {
  try {
    const response = await fetch('/api/bus_favorites');
    favoriteStops = await response.json();
    updateFavDisplay();
    console.log(`‚úÖ Loaded ${favoriteStops.length} favorite bus stops`);
  } catch (error) {
    console.error('Failed to load favorites:', error);
  }
}

// UPDATED: Add favorite Bus Stops to database
async function addFavorite(code, desc) {
  if (favoriteStops.find(f => f.code === code)) {
    alert("Already added!");
    return;
  }
  
  try {
    const response = await fetch('/api/bus_favorites/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, desc })
    });
    
    const result = await response.json();
    if (result.success) {
      favoriteStops.push({ code, desc });
      updateFavDisplay();
    } else {
      alert("Failed to add favorite: " + (result.error || "Unknown error"));
    }
  } catch (error) {
    console.error('Error adding favorite:', error);
    alert("Failed to add favorite");
  }
}

// UPDATED: Remove favorite from database
async function removeFavorite(code) {
  try {
    const response = await fetch('/api/bus_favorites/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    
    const result = await response.json();
    if (result.success) {
      favoriteStops = favoriteStops.filter(f => f.code !== code);
      updateFavDisplay();
    } else {
      alert("Failed to remove favorite: " + (result.error || "Unknown error"));
    }
  } catch (error) {
    console.error('Error removing favorite:', error);
    alert("Failed to remove favorite");
  }
}

//Update users favorite stops
function updateFavDisplay(){
  const favDiv = document.getElementById("favList");
  favDiv.innerHTML = "";
  favoriteStops.forEach(f => {
    const div = document.createElement("div");
    div.className = "favorite-stop";
    div.innerHTML = `${f.desc}<span class="delete" onclick="removeFavorite('${f.code}')">üóë</span>`;
    div.onclick = () => loadArrivals(f.code, f.desc);
    favDiv.appendChild(div);
  });
}

// Add user's saved locations in settings to map----- NOT WORKING ------
async function loadUserSavedLocations() {
  try {
    const response = await fetch('/api/user_locations');
    const locations = await response.json();
    
    // Clear existing saved location markers
    savedLocationMarkers.forEach(marker => map.removeLayer(marker));
    savedLocationMarkers = [];
    
    // Add markers for each saved location
    locations.forEach(loc => {
      if (loc.lat && loc.lng) {
        // Create custom icon for saved locations
        const icon = loc.is_favourite 
          ? L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            })
          : L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
        
        const marker = L.marker([loc.lat, loc.lng], { icon: icon });
        
        // Create popup content
        const popupContent = `
          <div style="min-width: 200px;">
            <h3 style="margin: 0 0 8px 0; color: #2d4a9d; font-size: 16px;">
              ${loc.is_favourite ? 'üåü ' : 'üìç '}${loc.label}
            </h3>
            ${loc.address ? `<p style="margin: 4px 0; font-size: 13px;"><strong>Address:</strong><br>${loc.address}</p>` : ''}
            ${loc.postal_code ? `<p style="margin: 4px 0; font-size: 13px;"><strong>Postal Code:</strong> ${loc.postal_code}</p>` : ''}
            <p style="margin: 8px 0 4px 0; font-size: 12px; color: #666;">
              ${loc.is_favourite ? 'Default Location' : 'Saved Location'}
            </p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
        marker.addTo(map);
        savedLocationMarkers.push(marker);
      }
    });
    
    console.log(`‚úÖ Loaded ${locations.length} saved location(s)`);
  } catch (error) {
    console.error('Failed to load saved locations:', error);
  }
}

async function loadAllStops(){
 const res=await fetch("bus_stops");
 const stops=await res.json();
 cluster.clearLayers();
 stops.forEach(s=>{
   const m=L.marker([s.lat,s.lon]).bindPopup(`
     <b>${s.code}</b><br><b>${s.desc}</b><br>${s.road}
     <button onclick="loadArrivals('${s.code}','${s.desc}')">Show Arrivals</button>
     <button onclick="addFavorite('${s.code}','${s.desc}')">Add Favs</button>
     <button onclick="addCompare('${s.code}','${s.desc}')">Compare</button>`);
   cluster.addLayer(m);
 });
 map.fitBounds(cluster.getBounds());
 // Load user's saved locations after bus stops are loaded
 loadUserSavedLocations();
 
 // Load favorites from database
 loadFavoritesFromDB();
}
loadAllStops();

function getETA(value){
  if(!value || value === "-") return "-";
  if(value < 1) return `<span class="bus-badge soon">Arr</span>`;
  if(value <= 3) return `<span class="bus-badge soon">${Math.round(value)} min</span>`;
  if(value <= 10) return `<span class="bus-badge medium">${Math.round(value)} min</span>`;
  return `<span class="bus-badge late">${Math.round(value)} min</span>`;
}

async function loadArrivals(code, desc){
 activeStop=code; activeStopName=desc;
 const res=await fetch(`/bus_arrivals/${code}`);
 const data=await res.json();
 const body=document.getElementById('arrivalBody');
 body.innerHTML=data.length?data.map(b=>`
   <tr><td>${b.service}</td><td>${getETA(b.eta[0])}</td><td>${getETA(b.eta[1])}</td><td>${getETA(b.eta[2])}</td><td>${b.type||"Unknown"}</td></tr>`
 ).join(""):"<tr><td colspan='5'><i>No data available.</i></td></tr>";
 document.getElementById('lastUpdate').innerText="Last updated: "+new Date().toLocaleTimeString();
}

function manualRefresh(){ if(activeStop) loadArrivals(activeStop,activeStopName); }
setInterval(()=>{ if(activeStop) loadArrivals(activeStop,activeStopName); refreshCompare(); },60000);

/* FAVORITES */
// function addFavorite(code,desc){
//   if(!favoriteStops.find(f=>f.code===code)){
//     favoriteStops.push({code,desc});
//     localStorage.setItem("favorites",JSON.stringify(favoriteStops));
//     updateFavDisplay();
//   } else alert("Already added!");
// }
// function removeFavorite(code){
//   favoriteStops=favoriteStops.filter(f=>f.code!==code);
//   localStorage.setItem("favorites",JSON.stringify(favoriteStops));
//   updateFavDisplay();
// }

/* DARK MODE (map stays light) */
function toggleDark(){
  document.body.classList.toggle("dark");
}

/* COMPARE */
async function addCompare(code,desc){
  if(compareStops.length>=3){ alert("You can compare up to 3 stops."); return; }
  if(compareStops.find(s=>s.code===code)) return;
  compareStops.push({code,desc});
  await renderCompareCard(code,desc);
}
async function renderCompareCard(code,desc){
  const res=await fetch(`/bus_arrivals/${code}`);
  const data=await res.json();
  const existing=document.getElementById("cmp-"+code);
  if(existing) existing.remove();
  const card=document.createElement("div");
  card.className="compare-card";
  card.setAttribute("id","cmp-"+code);
  card.innerHTML=`<h4>${desc}</h4>
  <button style="background:#e74c3c;color:white;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;" onclick="removeCompare('${code}')">Remove</button>
  <table class='styled-table'><thead><tr><th>Bus</th><th>Next</th></tr></thead>
  <tbody>${data.map(b=>`<tr><td>${b.service}</td><td>${b.eta[0]?getETA(b.eta[0]):"-"}</td></tr>`).join("")}</tbody></table>`;
  document.getElementById("compareContainer").appendChild(card);
}
function removeCompare(code){
  document.getElementById("cmp-"+code)?.remove();
  compareStops=compareStops.filter(s=>s.code!==code);
}
function refreshCompare(){
  compareStops.forEach(s=>renderCompareCard(s.code,s.desc));
}

/* SEARCH + RESET */
async function searchStops(){
 const q=document.getElementById('query').value.trim();
 if(!q)return;
 const res=await fetch(`bus_stops?query=${encodeURIComponent(q)}`);
 const stops=await res.json();
 cluster.clearLayers();
 stops.forEach(s=>{
   const m=L.marker([s.lat,s.lon]).bindPopup(`
     <b>${s.code}</b><br><b>${s.desc}</b><br>${s.road}
     <button onclick="loadArrivals('${s.code}','${s.desc}')">Show Arrivals</button>
     <button onclick="addFavorite('${s.code}','${s.desc}')">‚≠ê Add Fav</button>
     <button onclick="addCompare('${s.code}','${s.desc}')">Compare</button>`);
   cluster.addLayer(m);
 });
 map.fitBounds(cluster.getBounds());
}
function resetMap(){
  document.getElementById('query').value="";
  activeStop=""; activeStopName="";
  document.getElementById('arrivalBody').innerHTML="<tr><td colspan='5'><i>Click any stop marker on the map to view arrivals.</i></td></tr>";
  loadAllStops();
}
updateFavDisplay();
</script>
</body>
</div>
</html>
